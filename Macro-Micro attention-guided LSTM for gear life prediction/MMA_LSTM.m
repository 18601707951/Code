% =========================================================================
%                          Written by Yi Qin and Sheng Xiang
% =========================================================================
function [ life ] = MMA_LSTM( l , yita,traindata,testdata)
%%%Input parameters
%  l: the cell number of the input layer
%  yita: learing rate
%  traindata: the data set is used for prediction
%  testdata: full life cycle data 
%%%Output
%  life: Predicted gear life

test_data1=testdata;%Define testdata
l1=length(test_data1);%Determine the length of testdata
t=traindata;%Define traindata
data_num=length(t);
[m,n]=size(t);%Determine the dimension of training data
a=0;%Define linear normalization parameters
b1=1;
threshold=-477;%Define value of the preset threshold,and the specific circumstances are different.
for i=1:m
    zd(i)=max(t(i,1:data_num));
    zx(i)=min(t(i,1:data_num));
    for j=1:data_num
        if zd(i)==zx(i)
            gyh(i,j)=0.5;
        else
            gyh(i,j)=(b1-a)*(t(i,j)-zx(i))/(zd(i)-zx(i))+a;%linear normalization
        end
    end
end
for i=1:l+1
    for j=1:data_num-l
        y1(i,j)=gyh(i+j-1);%The training matrix is constructed according to the number of cells in the input layer
    end
end
train_data=y1(1:l,:);%Determine input matrix
test_data=y1(l+1,:);%Determine ouput vector
%% Set the number of network units
o1=size(test_data,1);%Defines the number of cells in the output layer
cell_num=floor(sqrt(l+o1))+10;%Defines the number of cells in the hidden layer
%% Network weight initialization (standard initialization method)
%weight initialization of forget gate
uf=unifrnd(-1/sqrt(l),1/sqrt(l),cell_num,l);
wf=unifrnd(-1/sqrt(cell_num),1/sqrt(cell_num),cell_num,cell_num);
bf=zeros(cell_num,1);
%weight initialization of input gate
ui=unifrnd(-1/sqrt(l),1/sqrt(l),cell_num,l);
wi=unifrnd(-1/sqrt(cell_num),1/sqrt(cell_num),cell_num,cell_num);
bi=zeros(cell_num,1);
uc=unifrnd(-1/sqrt(l),1/sqrt(l),cell_num,l);
wc=unifrnd(-1/sqrt(cell_num),1/sqrt(cell_num),cell_num,cell_num);
bc=zeros(cell_num,1);
%weight initialization of ouyput gate
uo=unifrnd(-1/sqrt(l),1/sqrt(l),cell_num,l);
wo=unifrnd(-1/sqrt(cell_num),1/sqrt(cell_num),cell_num,cell_num);
bo=zeros(cell_num,1);
%weight initialization from hidden layer to output layer
w=unifrnd(-1/sqrt(cell_num),1/sqrt(cell_num),o1,cell_num);
b=zeros(o1,1);

%% The section of  network training learning
for iter=1:1000        
    for t=1:data_num-l
  %Macro attention coefficient      
         X=mean(train_data,1);
         D=0;
         for V=1:data_num-l
             D=exp(X(:,V)*X(:,data_num-l)/sqrt(data_num-l))+D;
         end
         X1=1+X/D;
         
        if(t==1)
             A2=0;
             A=0;
            B=0;
            Sc=uc*train_data(:,t)+bc;%The input to the storage cell before updating
            C=tanh(Sc);%The output to the storage cell before updating
            Si=ui*train_data(:,t)+bi;%The input of the input gate
            So=uo*train_data(:,t)+bo;%The input of the output gate
            for n=1:cell_num
                i(n,1)=1/(1+exp(-Si(n,1)));%The output of the input gate
                o(n,1)=1/(1+exp(-So(n,1)));%The output of the output gate
            end
            Sf=zeros(cell_num,1);%The input of the forget gate
            f=zeros(cell_num,1);%The output of the forget gate
            c(:,t)=i.*C;%The output of the updated storage cell
        else
             %Micro attention coefficient    
            A1=0;
             for v1=1:cell_num
             A1=exp(test_data(:,t)*h(v1,t-1)/sqrt(l+cell_num))+A1;
             end
            for v=1:l           
                 A=exp(train_data(v,t)*test_data(:,t)/sqrt(l+cell_num))+A;
            end
            A2=A1+A;
                 B=[];
                 for i=1:l
                     B=[B,1+exp(train_data(i,t)*X1(:,t)*test_data(:,t)/sqrt(l+cell_num))/A2];
                 end
            
                 
           Sc=uc*(B'.*train_data(:,t))+wc*h(:,t-1).*((1+exp(test_data(:,t)*h(:,t-1)/sqrt(l+cell_num))/A2))+bc;
            C=tanh(Sc);
            Si=ui*(B'.*train_data(:,t))+wi*h(:,t-1).*((1+exp(test_data(:,t)*h(:,t-1)/sqrt(l+cell_num))/A2))+bi;
            Sf=uf*(B'.*train_data(:,t))+wf*h(:,t-1).*((1+exp(test_data(:,t)*h(:,t-1)/sqrt(l+cell_num))/A2))+bf;
            So=uo*(B'.*train_data(:,t))+wo*h(:,t-1).*((1+exp(test_data(:,t)*h(:,t-1)/sqrt(l+cell_num))/A2))+bo;
            for n=1:cell_num
                i(n,1)=1/(1+exp(-Si(n,1)));
                f(n,1)=1/(1+exp(-Sf(n,1)));
                o(n,1)=1/(1+exp(-So(n,1)));
            end
            c(:,t)=i.*C+c(:,t-1).*f;%The output of the updated storage cell
        end
        
         
        h(:,t)=tanh(c(:,t)).*o;%Hidden layer output
        S=w*h(:,t)+b;%Output layer input
        y(:,t)=S;%Output layer output
        y2(t)=(zd-zx)*(y(t)-a)/(b1-a)+zx;%Inverse linear normalization
        %Error calculation
        Error=y(:,t)-test_data(:,t);
        Error_cost(t,iter)=sum(Error.^2);
            [w,b,uo,wo,bo,uc,wc,bc,ui,wi,...
    bi,uf,wf,bf]=LSTM_updata_weight1...
    (t,yita,Error,w,b,uo,wo,bo,uc,wc,...
    bc,ui,wi,bi,uf,wf,bf,Sc,...
    C,i,f,c,o,h,train_data,B,A2,l,cell_num);% weight update
    end
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    if(max(Error_cost(:,iter))<0.01)%Set accuracy
        break;
    end
    iter
    max(Error_cost(:,iter))
end
%% COST figure
figure
plot(1:size(Error_cost,2),Error_cost(t,1:size(Error_cost,2)),'b','linewidth',2)%
set(gca,'FontName','timesnewroman','FontSize',18,'FontWeight','bold')% 
title('Error-cost');
%% The section of prediction
for t=data_num-l+1:400
        train_data(:,t)=y(t-l:t-1)';%Take the reciprocal output of the NN as input
          A=0;
           A1=0;
            A2=0;
            for v=1:l
                A=exp(train_data(v,t)*train_data(cell_num,t)/sqrt(l+cell_num))+A;
     
            
            end
              for v1=1:cell_num
                 A1=exp(h(v1,t-1)*train_data(cell_num,t)/sqrt(l+cell_num))+A1;
              end
             A2=A1+A;
                 B=[];
                 for i=1:l
                    B=[B,1+exp(train_data(i,t)*train_data(cell_num,t)/sqrt(l+cell_num))/A2];
                 end
                  Sc=uc*(B'.*train_data(:,t))+wc*h(:,t-1).*(1+exp(h(:,t-1)*train_data(cell_num,t))/A/sqrt(l+cell_num))+bc;
        C=tanh(Sc);
        Si=ui*train_data(:,t)+wi*h(:,t-1)+bi;
        Sf=uf*train_data(:,t)+wf*h(:,t-1)+bf;
        So=uo*train_data(:,t)+wo*h(:,t-1)+bo;
        for n=1:cell_num
                i(n,1)=1/(1+exp(-Si(n,1)));
                f(n,1)=1/(1+exp(-Sf(n,1)));
                o(n,1)=1/(1+exp(-So(n,1)));
        end
        c(:,t)=i.*C+c(:,t-1).*f;
        h(:,t)=tanh(c(:,t)).*o;
        S=w*h(:,t)+b;
        y(:,t)=S;
        y2(t)=(zd-zx)*(y(t)-a)/(b1-a)+zx;
        if abs(y2(t))>abs(threshold)&&t>l1-l
            break
        end
end
life=0;
for i=data_num-l+1:length(y2)
    if abs(y2(i))>abs(threshold)
        life=i+l;%Determine Life (represent by health characteristic point number)
        break
    end
end
% figure of degradation tracking 

figure
y3=[y2(1:data_num-l) y2(data_num-l+1:l1-l) test_data1(l+1:l1)];
plot(l+1:l1,test_data1(l+1:l1),'b*',l+1:data_num,y2(1:data_num-l),'r',data_num+1:l1,y2(data_num-l+1:l1-l),'k*','linewidth',4)%Draw the predictions
hold on
x11=[1 470];
y11=[threshold threshold];
plot(x11,y11,'g-','linewidth',4)
set(gca,'FontName','timesnewroman','FontSize',10,'FontWeight','bold')
legend({'Actual value','Training value','Predictive value','Failure threshold'},'Location','SouthWest');
axis([0 470 2*min(y3) 2*max(y3)])
set(gca, 'LineWidth',4)  
xlabel('Serial number of the characteristic point')
ylabel('Fusion feature')




end

